<!-- index.html -->
<!-- Page d'accueil de l'application Axion -->
<!-- Fournit les √©l√©ments UI et les hooks pour le chat, l‚Äôingestion, les synth√®ses-->
<!-- et les extractions (utilise /api/* pour les actions et affiche/telecharge les r√©sultats)-->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>{{ title | default("Assitant d'enqu√™te intelligent") }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- JS existants (ordre important) -->
  <script defer src="static/js/utils.js"></script>
  <script defer src="static/js/theme.js"></script>
  <script defer src="static/js/extract.js"></script>
  <script defer src="static/js/chat.js"></script>
  <script defer src="static/js/app.v2.js"></script>
  <script defer src="static/js/chat-upload.js"></script>
  <script defer src="static/js/ui.js"></script>
  <script defer src="static/js/ingest.js?v=8"></script>

  <!-- th√®me initial tr√®s t√¥t -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme');
        const mode = saved || 'dark';
        document.documentElement.setAttribute('data-theme', mode);
        document.documentElement.style.colorScheme = (mode === 'light') ? 'light' : 'dark';
      } catch (e) {}
    })();
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="static/css/main.css" />
  <!-- Alpine -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
</head>

<body
  x-data="{
    ...chatApp(),
    sidePanel: 'none',
    showHelp: false,
    useCase: true,
    personQuery: '',
    lastExtraction: null,
    showProgress: false,
    progress: 0,
    phase: '',
    task: '',
    eta: '',
    ocrPages: 0
  }"
  x-init="init()"
>
  <!-- rail -->
  <aside class="app-rail">
    <!-- Logo fixe dans le rail (plus de binding is-loading pour l‚Äôinstant) -->
    <div class="brand-logo-frame">
       <div class="brand-logo-ring">
         <img src="static/img/logo-assistant.png" class="brand-logo-img" alt="Axion">
       </div>
     </div>

    <button type="button" class="rail-btn"
      :class="{ 'is-active': sidePanel === 'none' }"
      @click="sidePanel = 'none'">
      üí¨ <span class="label">Chat</span>
    </button>

    <button type="button" class="rail-btn"
      :class="{ 'is-active': sidePanel === 'params' }"
      @click="sidePanel = (sidePanel === 'params' ? 'none' : 'params')">
      ‚öôÔ∏è <span class="label">Param√®tres</span>
    </button>

    <button type="button" class="rail-btn"
      :class="{ 'is-active': sidePanel === 'case' }"
      @click="sidePanel = (sidePanel === 'case' ? 'none' : 'case')">
      üìÅ <span class="label">Affaires</span>
    </button>

    <button type="button" class="rail-btn"
      :class="{ 'is-active': sidePanel === 'ingest' }"
      @click="sidePanel = (sidePanel === 'ingest' ? 'none' : 'ingest')">
      üì• <span class="label">Ingestion</span>
    </button>

    <button type="button" class="rail-btn"
      :class="{ 'is-active': sidePanel === 'tools' }"
      @click="sidePanel = (sidePanel === 'tools' ? 'none' : 'tools')">
      üõ† <span class="label">Boite √† outils</span>
    </button>

    <div class="rail-bottom">
      <button id="rail-toggle" type="button" class="rail-btn" title="Afficher / masquer le rail">
        <span id="rail-icon">‚è¥</span>
        <span class="label">Rail</span>
      </button>

      <button id="help-btn" type="button" class="rail-btn" @click="showHelp = true; $nextTick(() => window.loadHelp())">
        ‚ùì <span class="label">Aide</span>
      </button>

      <button
        id="theme-toggle"
        type="button"
        class="rail-btn"
        title="Changer de th√®me"
        onclick="window.axionTheme && window.axionTheme.toggle()"
      >
        <span id="theme-icon">üåô</span>
        <span class="label">Th√®me</span>
      </button>

      <button
        id="theme-system"
        type="button"
        class="rail-btn"
        title="Suivre le th√®me de la machine"
        onclick="window.axionTheme && window.axionTheme.useSystem()"
      >
        üñ•Ô∏è <span class="label">Syst√®me</span>
      </button>
    </div>
  </aside>

  <div class="app-shell">
    <!-- chat -->
    <main class="chat-shell">
      <header class="chat-header">
        <h1>
          <span id="title-text">{{ title | default("Analyste judiciaire IA") }}</span>
        </h1>
      </header>

      <!-- panneau "pens√©es" -->
      <div x-show="think.show" x-transition.opacity.duration.150ms class="think-panel">
        <div class="card p-4 shadow-xl flex gap-3 items-start">
          <div class="text-lg">üí°</div>
          <div class="flex-1">
            <div class="font-semibold mb-1">Pens√©es (raisonnement)</div>
            <pre class="think-content" x-text="think.text"></pre>
          </div>
          <button class="pill text-xs opacity-80" @click="think.sticky = !think.sticky" x-text="think.sticky ? 'Auto: off' : 'Auto: on'"></button>
        </div>
      </div>

            <!-- messages -->
      <div id="scrollArea" class="chat-messages" x-ref="scrollArea">
        <template x-for="m in messages" :key="m.id">
          <div class="chat-row" :class="m.role === 'user' ? 'is-user' : 'is-assistant'">
            
            <!-- Avatar supprim√© (remplac√© par la colonne avatar fixe) -->
            <!-- bloc <div class="avatar"> ‚Ä¶ </div> retir√© -->            

            <!-- Bloc message + sources -->
            <div class="chat-msg-block">
              <!-- bulle -->
              <div class="chat-bubble" x-html="m.html"></div>

              <!-- bouton copier (assistant seulement) -->
              <button
                type="button"
                class="chat-copy-btn"
                x-show="m.role === 'assistant'"
                @click="copyMsg(m)"
                title="Copier le contenu"
              >
                ‚ßâ
              </button>

              <!-- sources -->
              <template x-if="m.sources && m.sources.length">
                <div class="chat-sources">
                  <template x-for="(s, idx) in m.sources" :key="idx">
                    <template x-if="s.url">
                      <a
                        class="chat-source-pill"
                        :href="s.url"
                        target="_blank"
                        rel="noreferrer"
                        x-text="s.page ? (s.source + ' (p. ' + s.page + ')') : (s.source || ('Source ' + (idx+1)))"
                      ></a>
                    </template>
                    <template x-if="!s.url && s.doc_hash">
                      <a
                        class="chat-source-pill"
                        :href="'/api/doc/' + s.doc_hash"
                        target="_blank"
                        rel="noreferrer"
                        x-text="s.page ? (s.source + ' (p. ' + s.page + ')') : (s.source || ('Source ' + (idx+1)))"
                      ></a>
                    </template>
                    <template x-if="!s.url && !s.doc_hash">
                      <span
                        class="chat-source-pill chat-source-pill--muted"
                        x-text="s.page ? (s.source + ' (p. ' + s.page + ')') : (s.source || ('Source ' + (idx+1)))"
                      ></span>
                    </template>
                  </template>
                </div>
              </template>
            </div> <!-- .chat-msg-block -->
          </div> <!-- .chat-row -->
        </template>
      </div> <!-- #scrollArea / .chat-messages -->

      <!-- Indicateur de contexte -->
      <div class="mt-2 flex flex-wrap gap-2 text-[0.72rem] text-slate-300">

        <!-- Contexte libre -->
        <div
          x-show="!(currentDocText && currentDocText.trim()) && !(useMemory && caseId)"
          class="inline-flex items-center gap-2 rounded-full bg-slate-800/60 border border-slate-600 px-3 py-1"
        >
          <span class="inline-block w-3 h-3 rounded-full bg-slate-400 shadow-sm"></span>
          <span>‚ö™Ô∏è Contexte libre</span>
        </div>

        <!-- Contexte dossier -->
        <div
          x-show="useMemory && caseId"
          class="inline-flex items-center gap-2 rounded-full bg-blue-900/40 border border-blue-600/60 px-3 py-1"
        >
          <span class="inline-block w-3 h-3 rounded-full bg-blue-400 shadow-sm"></span>
          <span>üîµ Dossier : <span x-text="caseId"></span></span>
        </div>
      </div>

      <!-- Badge + panneau document actif -->
      <div x-data="{ docOpen: false }" class="doc-context-wrapper">

        <!-- badge compact (toujours visible si document charg√©) -->
        <div
          x-show="currentDocText && currentDocText.trim()"
          class="inline-flex items-center gap-2 rounded-full bg-emerald-900/40 border border-emerald-600/60 px-3 py-1 cursor-pointer"
          @click="docOpen = !docOpen"
          title="Cliquer pour afficher/masquer les d√©tails du document"
        >
          <span class="inline-block w-3 h-3 rounded-full bg-emerald-400 shadow-sm"></span>
          <span>üü¢ Document : <span x-text="currentDocName || 'charg√©'"></span></span>
          <button type="button" class="ml-2 text-[0.7rem] opacity-80" @click.stop="docOpen = !docOpen">
            <span x-text="docOpen ? '‚ñ¥' : '‚ñæ'"></span>
          </button>
        </div>

        <!-- panneau d√©taill√© -->
        <div x-show="currentDocText && currentDocText.trim() && docOpen"
             x-transition
             class="mt-2 mb-1 flex items-center justify-between rounded-md border border-slate-700/60 bg-slate-900/60 px-3 py-1.5 text-xs text-slate-300">
          <div class="flex flex-col">
            <span class="font-medium">
              Document actif :
              <span x-text="currentDocName || 'Document charg√©'"></span>
            </span>
            <span class="text-[0.7rem] text-slate-400 mt-0.5">
              Les prochaines r√©ponses tiendront compte de ce document. Vous pouvez le retirer √† tout moment.
            </span>
          </div>
          <div class="flex items-center gap-2">
            <button type="button"
                    class="inline-flex items-center rounded px-2 py-1 text-[0.7rem] border border-slate-600 hover:bg-slate-800 transition"
                    @click="currentDocText=''; currentDocName=''; docOpen=false;">
              üßπ Retirer
            </button>
            <button type="button"
                    class="inline-flex items-center rounded px-2 py-1 text-[0.7rem] border border-slate-600 hover:bg-slate-800 transition"
                    @click="docOpen = false">
              Fermer
            </button>
          </div>
        </div>

      </div>

      <!-- input -->
      <form class="chat-input-bar" @submit.prevent="send()">
        <textarea x-model="message"
                  @keydown.enter.prevent="send()"
                  placeholder="√âcris ton message‚Ä¶"
                  rows="1"></textarea>
        <button id="send-btn" type="submit" class="btn" :disabled="sending">
          <span x-show="!sending">Envoyer</span>
          <span x-show="sending">‚Ä¶</span>
        </button>
      </form>
    </main>

    <!-- panneau lat√©ral -->
    <section class="side-panel" :class="{ 'is-open': sidePanel !== 'none' }">
      <!-- PARAM√àTRES -->
      <div class="panel-body" x-show="sidePanel === 'params'">
        <h2 class="panel-title">Param√®tres</h2>

        <label class="panel-toggle mt-4">
          <input type="checkbox" x-model="useMemory" @change="useCase = useMemory">
          <span>Travailler dans l'affaire s√©lectionn√©e</span>
        </label>

        <p class="panel-hint" x-show="useMemory && caseId">
          Affaire active : <strong x-text="caseId"></strong>
        </p>
        <p class="panel-hint" x-show="!useMemory">
          Contexte : <strong>sans affaire</strong>
        </p>

        <input type="hidden" id="case_id" :value="useMemory ? caseId : ''">
        <input type="hidden" id="model_name" :value="model">
      </div>

      <!-- AFFAIRES -->
      <div class="panel-body" x-show="sidePanel === 'case'">
        <h2 class="panel-title">Affaire</h2>
        <p class="panel-hint">S√©lectionner une affaire existante ou en cr√©er une.</p>

        <label class="panel-label">Affaires existantes</label>
        <select id="cases" class="panel-input" x-model="caseId" @change="loadDocs()">
          <option value="">‚Äî choisir une affaire ‚Äî</option>
          <template x-for="c in (cases || [])" :key="c">
            <option :value="c" x-text="c"></option>
          </template>
        </select>
        <div class="panel-hint" x-show="!(cases && cases.length)">Aucune affaire charg√©e.</div>

        <label class="panel-label mt-3">Nouvelle affaire</label>
        <textarea id="newcase" class="panel-input" rows="2" placeholder="ID de l'affaire‚Ä¶"></textarea>
        <button class="btn w-full mt-3" id="create-case-btn" @click="createCase()">Cr√©er l'affaire</button>

        <div class="panel-hint mt-4">
          Affaire actuelle : <strong x-text="caseId || '‚Äî'"></strong>
        </div>
      </div>

      <!-- INGESTION -->
      <div class="panel-body" x-show="sidePanel === 'ingest'">
        <h2 class="panel-title">Ingestion</h2>
        <p class="panel-hint">
          Fichiers pour :
          <strong x-text="useCase ? (caseId || '‚Äî') : 'hors affaire'"></strong>
        </p>

        <input id="files" name="files" type="file" multiple class="panel-input-file" />
        <button class="btn w-full mt-3" id="ingest-btn"
          @click="
            const saved = caseId;
            if (!useCase) caseId = '';
            ingest();
            caseId = saved;
          ">
          Lancer l'ingestion
        </button>

        <div class="ingest-progress" id="ingest-progress"
             x-show="sidePanel === 'ingest' && showProgress && progressKind === 'ingest'">
          <div class="flex items-center gap-2 mb-2">
            <div class="spinner"></div>
            <div class="text-sm" id="ingest-msg" x-text="phase || task || 'Traitement en cours‚Ä¶'"></div>
          </div>
          <div class="progressbar">
            <div class="progressbar-fill" id="ingest-progressbar" :style="`width:${progress}%`"></div>
          </div>
          <div class="text-xs mt-1 opacity-70">
            <span id="ingest-percent" x-text="progress.toFixed(1) + '%'"></span>
            <span x-show="eta"> ‚Ä¢ ETA ~ <span x-text="eta"></span></span>
            <span x-show="ocrPages>0"> ‚Ä¢ OCR: <span x-text="ocrPages"></span> p.</span>
          </div>
        </div>
      </div>

      <!-- OUTILS & SYNTH√àSE -->
      <div class="panel-body" x-show="sidePanel === 'tools'">
        <h2 class="panel-title">Outils & Synth√®se</h2>

        <div class="flex flex-col gap-3">
          <p class="panel-hint">Synth√®se d√©taill√©e du dossier</p>
          <button class="btn w-full" id="summary-btn" @click="makeLeaf()" :disabled="busy">
            Synth√®se th√©matique
          </button>

          <p class="panel-hint">R√©sum√©s chronologique des actes</p>
          <button class="btn w-full" type="button" @click="makeChrono('long')" :disabled="busy">
            Synth√®se chronologique
          </button>

          <p class="panel-hint">Rapport de synth√®se d'enqu√™te (police)</p>
          <button class="btn w-full" type="button" @click="makeChrono('short')" :disabled="busy">
            Rapport de synth√®se
          </button>
        </div>

        <div id="tools-progress"
             x-show="sidePanel === 'tools' && showProgress && (progressKind === 'leaf' || progressKind === 'chrono-long' || progressKind === 'chrono-short')"
             style="margin-top:1rem;">
           <div class="panel-hint mb-1">
             <template x-if="progressKind === 'leaf'">
               <span>Synth√®se th√©matique en cours‚Ä¶</span>
             </template>
             <template x-if="progressKind === 'chrono-long'">
               <span>Synth√®se chrono d√©taill√©e en cours‚Ä¶</span>
             </template>
             <template x-if="progressKind === 'chrono-short'">
               <span>Rapport de synth√®se en cours‚Ä¶</span>
             </template>
           </div>
           <div class="progressbar">
             <div class="progressbar-fill" :style="`width:${progress}%`"></div>
           </div>
           <div class="panel-hint" style="margin-top:.25rem;" x-text="phase || task || 'Pr√©paration‚Ä¶'"></div>
         </div>

        <div class="mt-4">
          <a id="leaf-download" href="#" class="panel-hint" style="display:none; margin-top:.75rem;" download>üì• T√©l√©charger la synth√®se th√©matique</a>
          <a id="chrono-long-download" href="#" class="panel-hint" style="display:none; margin-top:.4rem;" download>üì• T√©l√©charger la synth√®se chrono d√©taill√©e</a>
          <a id="chrono-short-download" href="#" class="panel-hint" style="display:none; margin-top:.4rem;" download>üì• T√©l√©charger le rapport de synth√®se</a>
        </div>

        <p class="panel-hint mt-2">
           Fichiers g√©n√©r√©s dans
           <code>/storage/cases/&lt;affaire&gt;/summaries/</code>.
         </p>

        <div class="mt-6">
          <label class="panel-label">Extraction d√©taill√©e d'une personne</label>
          <input type="text" class="panel-input mt-1" placeholder="Ex. Jean MARTIN n√© 1978" x-model="personQuery">
          <button class="btn w-full mt-3"
                  @click="
                    if (!personQuery) { alert('Indique un nom de personne'); return; }
                    const saved = caseId;
                    if (!useCase) caseId = '';
                    sending = true;
                    (function(){ const a = document.getElementById('person-download'); if (a) { a.style.display = 'none'; a.href = '#'; } })();
                    sendStructuredPersonExtraction(personQuery).finally(() => { sending = false; caseId = saved; });
                  ">
            Lancer l'extraction d√©taill√©e
          </button>

          <a id="person-download"
             href="#"
             class="panel-hint"
             style="display:none; margin-top:.4rem;"
             download>
            üì• T√©l√©charger la fiche personne
          </a>
        </div>

        <div class="mt-6">
          <label class="panel-label">Fiche d√©taill√©e d‚Äôun num√©ro de t√©l√©phone</label>
          <input type="text"
                 class="panel-input mt-1"
                 placeholder="Ex. 06 14 52 98 77 ou +33614529877"
                 x-model="phoneQuery">

          <button class="btn w-full mt-3"
                  @click="
                    if (!phoneQuery) { alert('Indique un num√©ro de t√©l√©phone'); return; }
                    const saved = caseId;
                    if (!useCase) caseId = '';
                    sending = true;
                    (function(){ const a = document.getElementById('phone-download'); if (a) { a.style.display = 'none'; a.href = '#'; } })();
                    sendStructuredPhoneExtraction(phoneQuery).finally(() => { sending = false; caseId = saved; });
                  ">
            G√©n√©rer la fiche t√©l√©phone
          </button>

          <a id="phone-download"
             href="#"
             class="panel-hint"
             style="display:none; margin-top:.4rem;"
             download>
            üì• T√©l√©charger la fiche t√©l√©phone
          </a>
        </div>

        <div class="mt-6">
          <label class="panel-label">Extractions th√©matiques</label>

          <label class="panel-toggle mt-2">
            <input type="checkbox" id="extractStrict" checked>
            <span>Lier au nom de la personne</span>
          </label>

          <label class="panel-label mt-2" for="selectTheme">Th√®me</label>
          <select id="selectTheme" class="panel-input">
            <option value="phones">T√©l√©phones</option>
            <option value="iban">IBAN / comptes</option>
            <option value="emails">Emails</option>
            <option value="plates">Plaques</option>
            <option value="ips">Adresses IP</option>
            <option value="telegram">Telegram</option>
            <option value="whatsapp">WhatsApp</option>
            <option value="snapchat">Snapchat</option>
          </select>

          <button type="button" class="btn w-full mt-3" id="btnExtractPhones">
            Extraire le th√®me
          </button>

          <button type="button" class="btn w-full mt-2 btn-outline" id="btnExtractScan">
            Scan avanc√©
          </button>

          <div id="extractStatus" class="panel-hint mt-2"></div>
          <pre id="extractOutput" class="panel-code" style="min-height:80px; max-height:170px; overflow:auto; margin-top:.35rem;"></pre>
        </div>

        <!-- Remplac√© : bouton extraction + sortie align√©s sur extractPhones() -->
        <button
          type="button"
          class="tools-action"
          @click="extractPhones()"
          :disabled="extracting"
        >
          <span x-show="!extracting">üìû Extraire les t√©l√©phones</span>
          <span x-show="extracting" class="typing dots">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          </span>
        </button>

        <div id="extractOutputPhones" class="panel-code" style="min-height:80px; max-height:170px; overflow:auto; margin-top:.35rem;"></div>
      </div>
    </section>
  </div> <!-- fin app-shell -->

  <!-- Aide / Tutoriel de d√©marrage -->
  <div x-show="showHelp" x-transition.opacity.duration.150ms class="modal-backdrop" @close-help.window="showHelp = false">
    <div class="modal" @click.outside="showHelp=false">
      <!-- Bouton Fermer toujours disponible (m√™me si fragment help.html ne l'inclut pas) -->
      <button
        class="help-close-btn"
        aria-label="Fermer l'aide"
        onclick="window.closeHelp && window.closeHelp()"
        style="position:absolute; right:.6rem; top:.6rem; background:transparent; border:0; font-size:1.1rem; cursor:pointer; z-index:10;">
        ‚úï
      </button>
       <div id="help-content" class="help-loading">Chargement de l'aide‚Ä¶</div>
     </div>
   </div>

  <!-- Script d'extraction d√©taill√©e (r√©utilise /api/chat) -->
  <script>
    window.sendStructuredPersonExtraction = async function(name) {
      const body = document.querySelector('body');
      const root = body && body._x_dataStack ? body._x_dataStack[0] : null;
      if (!root) return;

      const model = root.model || 'deepseek-v3.1:671b-cloud';
      const caseId = root.useMemory ? (root.caseId || '') : '';
      const mode = root.useMemory ? "memory" : "normal";

      // message user
      root.messages.push({
        id: 'user-' + Date.now(),
        role: 'user',
        html: 'üîé Extraction d√©taill√©e de la personne : <strong>' + name + '</strong>'
      });

      // message assistant temporaire avec avatar LLM + dots
      const safeName = root.escape ? root.escape(name) : name;
      let tempId;

      // si on dispose du helper du chat, on l'utilise pour avoir le m√™me avatar/spinner
      if (root.pushAssistantPlaceholder && root.updateAssistant && root.renderAnswer) {
        tempId = root.pushAssistantPlaceholder();
        const loadingHtml =
          '<span class="typing dots">' +
            '<span class="dot"></span><span class="dot"></span><span class="dot"></span>' +
          '</span>' +
          ' <span>Je parcours le dossier pour <strong>' + safeName + '</strong>‚Ä¶</span>';

        root.updateAssistant(tempId, root.renderAnswer(loadingHtml));
      } else {
        // fallback ancien comportement sans avatar
        tempId = 'assistant-loading-' + Date.now();
        root.messages.push({
          id: tempId,
          role: 'assistant',
          html: '<div class="flex items-center gap-2"><div class="spinner"></div><span>Je parcours le dossier pour <strong>' + safeName + '</strong>‚Ä¶</span></div>'
        });
      }

      // üëâ prompt sp√©cialis√© (utilis√© uniquement si on n‚Äôa pas d‚Äôaffaire)
      const systemPrompt = `
Tu es un analyste judiciaire fran√ßais. On te donne le nom d'une personne et tu as acc√®s √† un dossier (affaire) ing√©r√©.
Tu dois RASSEMBLER et STRUCTURER toutes les informations trouv√©es sur cette personne dans ce dossier.

FORME √Ä RESPECTER (d'abord texte lisible, ensuite JSON) :

1. Identit√©
   - Nom
   - Pr√©nom(s)
   - Alias √©ventuels
2. √âtat civil
   - Date de naissance (si connue)
   - Lieu de naissance (si connu)
   - Nationalit√©(s) (si connue(s))
3. Adresse(s)
   - Adresse actuelle ou la plus r√©cente
   - Autres adresses trouv√©es
4. Situation familiale
   - Conjoint(e) / compagnon(agne)
   - Enfants
   - Autres proches clairement identifi√©s
5. Coordonn√©es de contact
   - T√©l√©phones (üì±) avec indication s‚Äôils sont r√©ellement rattach√©s √† la personne
   - Emails (‚úâÔ∏è)
6. √âl√©ments administratifs / mat√©riels
   - IBAN / comptes (üè¶)
   - V√©hicules / plaques (üöó)
7. Liens / associations
   - Personnes associ√©es
   - Soci√©t√©s associ√©es
8. Sources
   - Toujours lister les documents/pages/chunks d‚Äôo√π tu tires les infos

Apr√®s cette partie lisible, tu donnes un objet JSON unique avec exactement cette structure :

{
  "identite": {
    "nom": "",
    "prenoms": [],
    "alias": [],
    "date_naissance": "",
    "lieu_naissance": "",
    "nationalites": []
  },
  "adresses": [
    { "adresse": "", "periode": "", "sources": [] }
  ],
  "situation_familiale": {
    "conjoint": "",
    "enfants": [],
    "autres_proches": []
  },
  "coordonnees": {
    "telephones": [
      { "numero": "", "type": "perso|pro|inconnu", "sources": [] }
    ],
    "emails": [
      { "email": "", "sources": [] }
    ]
  },
  "elements_materiels": {
    "iban": [
      { "iban": "", "banque": "", "sources": [] }
    ],
    "vehicules": [
      { "immatriculation": "", "marque": "", "modele": "", "sources": [] }
    ]
  },
  "liens": {
    "personnes_associees": [
      { "nom": "", "lien": "", "sources": [] }
    ],
    "societes_associees": [
      { "denomination": "", "role": "", "sources": [] }
    ]
  },
  "sources": []
}

R√àGLES IMPORTANTES
- Si une info est absente dans le dossier, mets juste "" ou [] mais conserve la cl√©.
- N'invente pas : tu ne fais qu'agr√©ger ce qu'il y a dans le dossier.
- Toujours mettre des "sources": ["nom_doc", "p.12"] quand c'est possible.
`.trim();

      const userPrompt = `Personne √† extraire : "${name}"`;

      let answerText = '';
      let payload = null;

      try {
        if (caseId) {
          // üîó Mode "dans une affaire" ‚Üí on appelle le backend d√©di√©
          const fd = new FormData();
          fd.append("case_id", caseId);
          fd.append("person", name);
          fd.append("model", model || "deepseek-v3.1:671b-cloud");

          const resp = await fetch("/api/extract/person/profile", {
            method: "POST",
            body: fd,
          });

          if (!resp.ok) {
            const txt = await resp.text().catch(() => "");
            throw new Error("HTTP " + resp.status + " " + txt);
          }

          const data = await resp.json().catch(() => null);
          if (!data) {
            throw new Error("R√©ponse JSON invalide depuis /api/extract/person/profile");
          }

          answerText = data.answer || "";
          payload = data;
        } else {
          // üß© Fallback hors affaire ‚Üí via /api/chat
          const resp = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: userPrompt,
              model: model || "deepseek-v3.1:671b-cloud",
              stream: "plain",
              system: systemPrompt,
              case_id: null,
              mode: mode
            })
          });

          const raw = await resp.text();

          let parsedJson = null;
          try {
            const parsed = JSON.parse(raw);
            answerText = parsed.answer || raw;
            parsedJson = parsed.answer ? parsed : null;
          } catch (e) {
            answerText = raw;
            parsedJson = null;
          }

          if (answerText.includes('}{"answer"')) {
            answerText = answerText.split('}{"answer"')[0] + '}';
          }

          payload = parsedJson || { answer: answerText };
        }
      } catch (err) {
        answerText = '‚ùå Erreur pendant l‚Äôextraction : ' + (err && err.message ? err.message : String(err));
        payload = { answer: answerText };
      }

      // on garde pour l'export / t√©l√©chargement
      root.lastExtraction = payload;

      // on met √† jour le lien de t√©l√©chargement si le backend a renvoy√© un fichier
      try {
        const a = document.getElementById("person-download");
        if (a) {
          const dl = payload && (payload.download_url || (payload.data && payload.data.download_url));
          if (dl) {
            a.href = dl;
            a.style.display = "inline-block";
          } else {
            a.href = "#";
            a.style.display = "none";
          }
        }
      } catch (e) {}

      // on remplace le message "loading" par la r√©ponse finale
      const rawText = answerText || "";

      const rendered =
        (root.renderAnswer && typeof root.renderAnswer === "function")
          ? root.renderAnswer(rawText)
          : (
              '<pre style="white-space: pre-wrap; word-break: break-word;">' +
              rawText +
              "</pre>"
            );

      if (root.updateAssistant && tempId) {
        // üßΩ arr√™t du spinner sur l'avatar
        const mm = root.messages.find(m => m.id === tempId);
        if (mm && mm.avatarHtml) {
          mm.avatarHtml = mm.avatarHtml
            .replace(/\btyping\b/g, "")
            .replace(/\bthinking\b/g, "")
            .replace(/\s+/g, " ")
            .trim();
        }

        root.updateAssistant(tempId, rendered);
      } else {
        const idx = root.messages.findIndex((m) => m.id === tempId);
        if (idx !== -1) {
          root.messages[idx] = {
            id: "assistant-" + Date.now(),
            role: "assistant",
            html: rendered,
          };
        } else {
          root.messages.push({
            id: "assistant-" + Date.now(),
            role: "assistant",
            html: rendered,
          });
        }
      }

      // scroll en bas
      try {
        const scrollArea = document.querySelector('.chat-messages');
        if (scrollArea) scrollArea.scrollTop = scrollArea.scrollHeight;
      } catch (e) {}
    };
  </script>

  <script>
    window.sendStructuredPhoneExtraction = async function(numberRaw) {
      const body = document.querySelector('body');
      const root = body && body._x_dataStack ? body._x_dataStack[0] : null;
      if (!root) return;

      const phone = (numberRaw || '').trim();
      if (!phone) return;

      const model = root.model || 'deepseek-v3.1:671b-cloud';
      const caseId = root.useMemory ? (root.caseId || '') : '';
      const mode = root.useMemory ? "memory" : "normal";

      if (!caseId) {
        // pas d'affaire ‚Üí petit message dans le chat
        root.messages.push({
          id: 'assistant-' + Date.now(),
          role: 'assistant',
          html: "<span class='text-red-400'>La fiche t√©l√©phone n√©cessite une affaire active. Active la m√©moire et choisis un dossier.</span>"
        });
        return;
      }

      // 1) message user
      root.messages.push({
        id: 'user-' + Date.now(),
        role: 'user',
        html: 'üîé Fiche d√©taill√©e du num√©ro : <strong>' + phone + '</strong>'
      });

      // 2) message assistant temporaire avec avatar LLM + dots
      const safePhone = root.escape ? root.escape(phone) : phone;
      let tempId;

      if (root.pushAssistantPlaceholder && root.updateAssistant && root.renderAnswer) {
        tempId = root.pushAssistantPlaceholder();
        const loadingHtml =
          '<span class="typing dots">' +
            '<span class="dot"></span><span class="dot"></span><span class="dot"></span>' +
          '</span>' +
          ' <span>Je parcours le dossier pour le num√©ro <strong>' + safePhone + '</strong>‚Ä¶</span>';

        root.updateAssistant(tempId, root.renderAnswer(loadingHtml));
      } else {
        // fallback sans avatar
        tempId = 'assistant-loading-phone-' + Date.now();
        root.messages.push({
          id: tempId,
          role: 'assistant',
          html: '<div class="flex items-center gap-2"><div class="spinner"></div><span>Je parcours le dossier pour le num√©ro <strong>' + safePhone + '</strong>‚Ä¶</span></div>'
        });
      }

      let answerText = '';
      let payload = null;

      try {
        // Appel direct √† la route fiche t√©l√©phone
        const fd = new FormData();
        fd.append("case_id", caseId);
        fd.append("number", phone);
        fd.append("model", model || "deepseek-v3.1:671b-cloud");

        const resp = await fetch("/api/phones/report", {
          method: "POST",
          body: fd,
        });

        if (!resp.ok) {
          const txt = await resp.text().catch(() => "");
          throw new Error("HTTP " + resp.status + " " + txt);
        }

        payload = await resp.json().catch(() => null);
        if (!payload) {
          throw new Error("R√©ponse JSON invalide depuis /api/phones/report");
        }

        answerText =
          payload.answer ||
          (
            "Fiche t√©l√©phone g√©n√©r√©e pour " +
            (payload.normalized_number || phone) +
            " (" +
            (payload.hits_count ?? "?") +
            " occurrence(s) dans le dossier)."
          );
      } catch (err) {
        answerText =
          "‚ùå Erreur pendant la g√©n√©ration de la fiche t√©l√©phone : " +
          (err && err.message ? err.message : String(err));
        payload = { answer: answerText };
      }

      // 3) mise √† jour du lien de t√©l√©chargement
      try {
        const a = document.getElementById("phone-download");
        if (a) {
          const dl = (payload && (payload.download_url || payload.path)) || null;
          if (dl) {
            a.href = dl;
            a.style.display = "inline-block";
          } else {
            a.href = "#";
            a.style.display = "none";
          }
        }
      } catch (e) {}

      // 4) RENDU COMME LE CHAT NORMAL (Markdown -> HTML) + arr√™t du spinner

      const rawText = answerText || "";
      const rendered =
        (root.renderAnswer && typeof root.renderAnswer === "function")
          ? root.renderAnswer(rawText)   // üëâ Markdown converti (###, listes, etc.)
          : (
              '<pre style="white-space: pre-wrap; word-break: break-word;">' +
              rawText +
              "</pre>"
            );

      if (root.updateAssistant && tempId) {
        // üßΩ arr√™t du spinner sur l'avatar
        const mm = root.messages.find(m => m.id === tempId);
        if (mm && mm.avatarHtml) {
          mm.avatarHtml = mm.avatarHtml
            .replace(/\btyping\b/g, "")
            .replace(/\bthinking\b/g, "")
            .replace(/\s+/g, " ")
            .trim();
        }

        // et on remplace le contenu par la r√©ponse finale format√©e
        root.updateAssistant(tempId, rendered);
      } else {
        // fallback sans helper
        const idx = root.messages.findIndex((m) => m.id === tempId);
        if (idx !== -1) {
          root.messages[idx] = {
            id: "assistant-" + Date.now(),
            role: "assistant",
            html: rendered,
          };
        } else {
          root.messages.push({
            id: "assistant-" + Date.now(),
            role: "assistant",
            html: rendered,
          });
        }
      }

      // 5) scroll en bas
      try {
        const scrollArea = document.querySelector(".chat-messages");
        if (scrollArea) scrollArea.scrollTop = scrollArea.scrollHeight;
      } catch (e) {}
    };
  </script>

  <script src="{{ url_for('static', path='js/theme.js') }}"></script>
  <script src="{{ url_for('static', path='js/rail.js') }}"></script>

  <script>
  window.helpLoaded = false;
  window.loadHelp = async function () {
    if (window.helpLoaded) return;
    const el = document.getElementById("help-content");
    if (!el) return console.warn("help: #help-content not found");
    el.innerText = "Chargement de l'aide‚Ä¶";
    try {
      const res = await fetch("static/help.html", { cache: "force-cache" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      el.innerHTML = await res.text();
      window.helpLoaded = true;
      // sommaire -> scroll smooth
      el.querySelectorAll(".help-toc a").forEach(a => {
        a.addEventListener("click", (ev) => {
          ev.preventDefault();
          const id = a.getAttribute("href").slice(1);
          const target = el.querySelector('#' + id);
          if (target) target.scrollIntoView({behavior: 'smooth', block: 'start'});
        });
      });
    } catch (e) {
      console.error("help load failed:", e);
      el.innerText = "Impossible de charger l'aide.";
    }
  };

  // Si tu utilises Alpine pour ouvrir l'aide via un bouton, appelle loadHelp au click :
  // <button @click="showHelp = true; $nextTick(() => window.loadHelp())">Aide</button>
</script>

<script>
  // Stub de s√©curit√© : √©vite ReferenceError si des handlers inline appellent phoneQuery
  if (typeof window.phoneQuery === "undefined") {
    window.phoneQuery = function(arg) {
      console.warn("phoneQuery appel√© mais non d√©fini:", arg);
      // TODO: router vers la vraie fonction si existante, ex :
      // if (window.extractPhone) return window.extractPhone(arg);
    };
  }
</script>

<!-- script global minimal (placer pr√®s du loadHelp existant, avant </body>) -->
<script>
  // dispatch d'un √©v√©nement pour fermer la modale (utilis√© par le bouton du fragment)
  if (typeof window.closeHelp === "undefined") {
    window.closeHelp = function () {
      window.dispatchEvent(new Event('close-help'));
    };
  }
</script>

</body>
</html>
